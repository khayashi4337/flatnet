# Promtail Configuration
# Phase 4, Stage 2: Logging Infrastructure
#
# Promtail is an agent which ships the contents of local logs to Loki.
# This configuration collects logs from Gateway (OpenResty), CNI Plugin, and containers.

server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /var/promtail/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push
    # Note: tenant_id is ignored when Loki has auth_enabled: false
    # Keeping it here for future multi-tenant support
    tenant_id: flatnet
    batchwait: 1s
    batchsize: 1048576  # 1MB
    timeout: 10s

scrape_configs:
  # ============================================
  # Gateway (OpenResty on Windows) access logs
  # WSL2 accesses Windows logs via /mnt/f/flatnet/logs/
  # Note: error.log is handled by a separate job with different parsing
  # ============================================
  - job_name: gateway
    static_configs:
      - targets:
          - localhost
        labels:
          job: gateway
          component: openresty
          __path__: /mnt/f/flatnet/logs/access.log
    pipeline_stages:
      # Parse nginx combined log format
      - regex:
          expression: '^(?P<remote_addr>[\d\.]+) - (?P<remote_user>\S+) \[(?P<time_local>[^\]]+)\] "(?P<request>[^"]*)" (?P<status>\d+) (?P<body_bytes_sent>\d+) "(?P<http_referer>[^"]*)" "(?P<http_user_agent>[^"]*)"'
      - labels:
          status:
      - timestamp:
          source: time_local
          format: "02/Jan/2006:15:04:05 -0700"
      # Classify log level based on status code
      # Default to "info" if status is empty or non-numeric
      - template:
          source: level
          template: '{{ if .status }}{{ if ge (atoi .status) 500 }}error{{ else if ge (atoi .status) 400 }}warn{{ else }}info{{ end }}{{ else }}info{{ end }}'
      - labels:
          level:

  # ============================================
  # Gateway error logs (separate parsing)
  # ============================================
  - job_name: gateway-error
    static_configs:
      - targets:
          - localhost
        labels:
          job: gateway
          component: openresty
          log_type: error
          __path__: /mnt/f/flatnet/logs/error.log
    pipeline_stages:
      - regex:
          expression: '^(?P<timestamp>\d{4}/\d{2}/\d{2} \d{2}:\d{2}:\d{2}) \[(?P<level>\w+)\] (?P<pid>\d+)#(?P<tid>\d+): (?P<message>.*)'
      - labels:
          level:
      - timestamp:
          source: timestamp
          format: "2006/01/02 15:04:05"

  # ============================================
  # CNI Plugin logs (WSL2 native)
  # ============================================
  - job_name: cni-plugin
    static_configs:
      - targets:
          - localhost
        labels:
          job: cni-plugin
          component: flatnet-cni
          __path__: /var/log/flatnet/*.log
    pipeline_stages:
      # Parse JSON structured logs (if available)
      - json:
          expressions:
            timestamp: timestamp
            level: level
            message: message
            component: component
      - labels:
          level:
          component:
      - timestamp:
          source: timestamp
          format: RFC3339

  # ============================================
  # Podman container logs
  # ============================================
  - job_name: containers
    static_configs:
      - targets:
          - localhost
        labels:
          job: containers
          __path__: /var/lib/containers/storage/overlay-containers/*/userdata/ctr.log
    pipeline_stages:
      # Podman logs are in JSON format
      - json:
          expressions:
            stream: stream
            log: log
            time: time
      - labels:
          stream:
      - timestamp:
          source: time
          format: RFC3339Nano
      - output:
          source: log

  # ============================================
  # Monitoring stack logs (Prometheus, Grafana, etc.)
  # ============================================
  - job_name: monitoring
    static_configs:
      - targets:
          - localhost
        labels:
          job: monitoring
          __path__: /var/log/flatnet/monitoring/*.log
    pipeline_stages:
      - json:
          expressions:
            level: level
            msg: msg
            ts: ts
      - labels:
          level:
      - timestamp:
          source: ts
          format: RFC3339

# Limit resource usage
limits_config:
  readline_rate: 100
  readline_burst: 1000
  readline_rate_enabled: true
