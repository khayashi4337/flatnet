# Flatnet Gateway - Forgejo Proxy Configuration
# Phase 1, Stage 3: Forgejo Integration
#
# This file is included from nginx.conf to provide Forgejo-specific settings.
# It defines the upstream and location blocks for Forgejo Git service.
#
# Usage:
#   1. Include this file in the http block of nginx.conf
#   2. Run scripts/update-upstream.sh to update WSL2 IP
#   3. Deploy with scripts/deploy-config.sh --reload
#
# Prerequisites:
#   - Forgejo container running on WSL2 port 3000
#   - proxy-params.conf in the same conf.d directory
#   - websocket-params.conf in the same conf.d directory

#==============================================================================
# Forgejo Upstream Definition
#==============================================================================

# Forgejo backend server
# IP address is updated by scripts/update-upstream.sh
# Do not manually edit the IP - use the script instead
upstream forgejo {
    server 172.0.0.1:3000;  # Placeholder - updated by update-upstream.sh
    keepalive 32;  # Keep-alive connections for better performance
}

#==============================================================================
# Connection Upgrade Map (for WebSocket)
#==============================================================================

# Map for handling WebSocket upgrade header
# This enables proper WebSocket connection handling for Forgejo's live features
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

#==============================================================================
# Forgejo Server Block
#==============================================================================

server {
    # Listen on port 80 for all interfaces
    # This allows access from LAN
    listen 80;

    # Accept any server name (for flexibility)
    # Can be changed to specific domain if needed
    server_name _;

    # Character encoding
    charset utf-8;

    # Git の大きなファイル対応（デフォルト）
    # Default max body size for Git operations
    client_max_body_size 100M;

    #--------------------------------------------------------------------------
    # Health Check Endpoint
    #--------------------------------------------------------------------------

    # Simple health check for monitoring and testing
    # Returns 200 OK with plain text "OK"
    location /health {
        access_log off;  # Don't log health checks
        default_type text/plain;
        return 200 'OK';
    }

    #--------------------------------------------------------------------------
    # Status Endpoint (for debugging)
    #--------------------------------------------------------------------------

    # Returns basic server information
    # Only accessible from localhost for security
    location /status {
        allow 127.0.0.1;
        deny all;

        access_log off;
        default_type application/json;
        return 200 '{"status":"running","service":"flatnet-gateway","stage":"3","backend":"forgejo"}';
    }

    #--------------------------------------------------------------------------
    # Forgejo Main Proxy
    #--------------------------------------------------------------------------

    # Default location - proxy all requests to Forgejo
    location / {
        # Include common proxy settings
        include F:/flatnet/config/conf.d/proxy-params.conf;

        # Git 操作用のタイムアウト延長
        # Extended timeouts for Git operations
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;

        # WebSocket 対応（Git over HTTP、ライブアップデート等）
        # WebSocket support for live updates, notifications, etc.
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;

        # バッファ設定（Git clone 等の大きなレスポンス用）
        # Buffer settings for large responses (git clone, etc.)
        proxy_buffering on;
        proxy_buffer_size 16k;
        proxy_buffers 8 32k;
        proxy_busy_buffers_size 64k;

        proxy_pass http://forgejo;
    }

    #--------------------------------------------------------------------------
    # Git LFS Endpoint
    #--------------------------------------------------------------------------

    # Git LFS 用のエンドポイント（大きなファイルのアップロード/ダウンロード）
    # Special handling for Git Large File Storage
    location ~ ^/.+\.git/info/lfs {
        # LFS 用に大きなボディサイズを許可
        # Allow large body size for LFS uploads
        client_max_body_size 1G;

        include F:/flatnet/config/conf.d/proxy-params.conf;

        # LFS 操作は時間がかかる場合がある
        # LFS operations may take longer
        proxy_read_timeout 600s;
        proxy_send_timeout 600s;

        proxy_pass http://forgejo;
    }

    #--------------------------------------------------------------------------
    # Git Smart HTTP Endpoints
    #--------------------------------------------------------------------------

    # Git Smart HTTP エンドポイント
    # Handle git-upload-pack and git-receive-pack for clone/push
    location ~ ^/.+\.git/(HEAD|info/refs|objects/|git-upload-pack|git-receive-pack) {
        include F:/flatnet/config/conf.d/proxy-params.conf;

        # Git 操作用のタイムアウト延長
        # Extended timeouts for Git operations
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;

        # Git プッシュ時の大きなパックファイル対応
        # Allow large pack files during git push
        client_max_body_size 500M;

        proxy_pass http://forgejo;
    }

    #--------------------------------------------------------------------------
    # Error Pages
    #--------------------------------------------------------------------------

    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root F:/flatnet/openresty/html;
    }
}
