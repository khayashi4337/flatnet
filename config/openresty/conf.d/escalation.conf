# Flatnet Gateway - Escalation Configuration
# Phase 3, Stage 4: Graceful Escalation
#
# This configuration provides:
# - Shared memory for escalation state management
# - Escalation API endpoints
# - Healthcheck worker initialization
#
# Usage:
#   Include this file from nginx.conf (within http block)
#
# Prerequisites:
#   - flatnet.escalation module deployed
#   - flatnet.healthcheck module deployed
#   - flatnet.routing module deployed

#==============================================================================
# Shared Dict for Escalation State
# Add to http block in nginx.conf:
#   lua_shared_dict flatnet_escalation 5m;
#==============================================================================

#==============================================================================
# Escalation Parameters (adjust as needed)
#==============================================================================

# These parameters are set via init_worker_by_lua in nginx.conf
# This file documents the available settings:
#
# Healthcheck Settings:
#   healthcheck_interval = 5       -- seconds between checks
#   healthcheck_timeout = 5000     -- milliseconds
#   healthcheck_failure_threshold = 3  -- failures before fallback
#
# Latency Thresholds (milliseconds):
#   latency_warning = 500          -- log warning
#   latency_fallback = 1000        -- trigger fallback
#
# P2P Establishment:
#   p2p_attempt_timeout = 30       -- seconds
#
# Retry Backoff (seconds):
#   retry_intervals = {10, 30, 60, 300}  -- exponential backoff
#
# Fallback:
#   fallback_retry_delay = 30      -- seconds before retry

#==============================================================================
# Escalation API Endpoints
# These extend the API server defined in api.conf
#==============================================================================

# Note: These locations should be added to the API server block in api.conf
# or included via a separate location block configuration.

# Example location blocks (copy to api.conf if needed):
#
# # GET /api/escalation/state?ip=<ip> - Get escalation state
# location /api/escalation/state {
#     default_type application/json;
#     content_by_lua_block {
#         local cjson = require("cjson.safe")
#         local escalation = require("flatnet.escalation")
#
#         local ip = ngx.var.arg_ip
#         if not ip then
#             ngx.status = 400
#             ngx.say(cjson.encode({error = "ip parameter required"}))
#             return
#         end
#
#         local state = escalation.get_state(ip)
#         local metadata = escalation.get_metadata(ip)
#         local latency = escalation.get_latency(ip)
#
#         ngx.say(cjson.encode({
#             ip = ip,
#             state = state,
#             metadata = metadata,
#             latency = latency
#         }))
#     }
# }
#
# # GET /api/escalation/stats - Get escalation statistics
# location /api/escalation/stats {
#     default_type application/json;
#     content_by_lua_block {
#         local cjson = require("cjson.safe")
#         local escalation = require("flatnet.escalation")
#         ngx.say(cjson.encode(escalation.stats()))
#     }
# }
#
# # GET /api/routing/route?ip=<ip> - Get route for IP
# location /api/routing/route {
#     default_type application/json;
#     content_by_lua_block {
#         local cjson = require("cjson.safe")
#         local routing = require("flatnet.routing")
#
#         local ip = ngx.var.arg_ip
#         if not ip then
#             ngx.status = 400
#             ngx.say(cjson.encode({error = "ip parameter required"}))
#             return
#         end
#
#         local route = routing.get_route(ip, {skip_p2p_attempt = true})
#         ngx.say(cjson.encode(route))
#     }
# }
#
# # GET /api/healthcheck/status - Get healthcheck status
# location /api/healthcheck/status {
#     default_type application/json;
#     content_by_lua_block {
#         local cjson = require("cjson.safe")
#         local healthcheck = require("flatnet.healthcheck")
#         ngx.say(cjson.encode(healthcheck.status()))
#     }
# }
