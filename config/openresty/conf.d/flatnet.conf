# Flatnet Gateway - Flatnet Container Proxy Configuration
# Phase 2, Stage 4: Integration
#
# This file provides proxy configuration for Flatnet containers.
# It enables access to containers via their Flatnet IP addresses.
#
# Usage:
#   1. Include this file via nginx.conf
#   2. Configure upstream blocks for each service
#   3. Reload: F:\flatnet\openresty\nginx.exe -c F:\flatnet\config\nginx.conf -s reload
#
# Prerequisites:
#   - Windows routing to 10.87.1.0/24 via WSL2 (setup-route.ps1)
#   - WSL2 IP forwarding enabled (setup-forwarding.sh)
#   - Flatnet containers running with assigned IPs

#==============================================================================
# Flatnet Service Upstreams
#==============================================================================

# Forgejo on Flatnet
# Update the IP address when container starts
# Default IP assumes first container after bridge (10.87.1.2)
upstream flatnet_forgejo {
    server 10.87.1.2:3000;
    keepalive 16;
}

# Generic web service upstream (example)
# Uncomment and configure as needed
# upstream flatnet_web {
#     server 10.87.1.3:80;
#     keepalive 8;
# }

#==============================================================================
# Forgejo Server Block (via Flatnet)
#==============================================================================

server {
    listen 3080;
    server_name _;

    charset utf-8;

    # Git operations may have large payloads
    client_max_body_size 100M;

    #--------------------------------------------------------------------------
    # Health Check
    #--------------------------------------------------------------------------

    location /health {
        access_log off;
        default_type text/plain;
        return 200 'OK';
    }

    #--------------------------------------------------------------------------
    # Status (localhost only)
    #--------------------------------------------------------------------------

    location /status {
        allow 127.0.0.1;
        allow ::1;
        deny all;

        access_log off;
        default_type application/json;
        return 200 '{"status":"running","service":"flatnet-gateway","backend":"flatnet-forgejo","stage":"4"}';
    }

    #--------------------------------------------------------------------------
    # Main Proxy to Flatnet Forgejo
    #--------------------------------------------------------------------------

    location / {
        include F:/flatnet/config/conf.d/proxy-params.conf;

        # Extended timeouts for Git operations
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;

        # WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;

        # Buffer settings for large responses
        proxy_buffering on;
        proxy_buffer_size 16k;
        proxy_buffers 8 32k;
        proxy_busy_buffers_size 64k;

        proxy_pass http://flatnet_forgejo;
    }

    #--------------------------------------------------------------------------
    # Git LFS
    #--------------------------------------------------------------------------

    location ~ ^/.+\.git/info/lfs {
        client_max_body_size 1G;
        include F:/flatnet/config/conf.d/proxy-params.conf;
        proxy_read_timeout 600s;
        proxy_send_timeout 600s;
        proxy_pass http://flatnet_forgejo;
    }

    #--------------------------------------------------------------------------
    # Git Smart HTTP
    #--------------------------------------------------------------------------

    location ~ ^/.+\.git/(HEAD|info/refs|objects/|git-upload-pack|git-receive-pack) {
        include F:/flatnet/config/conf.d/proxy-params.conf;
        proxy_read_timeout 300s;
        proxy_send_timeout 300s;
        client_max_body_size 500M;
        proxy_pass http://flatnet_forgejo;
    }

    #--------------------------------------------------------------------------
    # Error Pages
    #--------------------------------------------------------------------------

    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root F:/flatnet/openresty/html;
    }
}

#==============================================================================
# Dynamic Flatnet Proxy (IP-based routing)
#==============================================================================

# This server block allows direct IP access via hostname pattern
# Access: http://10-87-1-X.flatnet.local/ (requires hosts/DNS setup)
# The IP is extracted from the hostname and used as the backend

server {
    listen 80;

    # Match hostnames like: 10-87-1-2.flatnet.local
    # Dashes are used instead of dots for DNS compatibility
    # Only allow Flatnet subnet (10.87.X.X) for security
    server_name ~^(?<ip1>10)-(?<ip2>87)-(?<ip3>\d+)-(?<ip4>\d+)\.flatnet\.local$;

    charset utf-8;

    location / {
        # Reconstruct the IP address from captured groups
        # Security: Only 10.87.X.X is allowed by server_name regex
        set $backend_ip "$ip1.$ip2.$ip3.$ip4";
        set $backend "http://$backend_ip:80";

        include F:/flatnet/config/conf.d/proxy-params.conf;

        # Dynamic proxy_pass
        proxy_pass $backend;

        # Extended timeouts
        proxy_read_timeout 120s;
        proxy_send_timeout 120s;
    }

    location /health {
        access_log off;
        default_type text/plain;
        return 200 'OK';
    }

    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root F:/flatnet/openresty/html;
    }
}
