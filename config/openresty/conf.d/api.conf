# Flatnet Gateway - Internal API Configuration
# Phase 3, Stage 3: CNI Plugin Multihost Extension
#
# This configuration provides:
# - Internal API for container registration (Nebula network only)
# - Container info lookup for routing decisions
# - Health check and sync status endpoints
#
# Usage:
#   This file should be included from nginx.conf
#   Requires shared dict configuration in main http block

#==============================================================================
# Internal API Server (Nebula Network Only)
#==============================================================================

# Note: The listen address should be the Nebula IP of this host.
# Replace 10.100.X.1 with your host's Nebula IP (X = host_id)
# This ensures the API is only accessible within the Nebula network.

server {
    # Bind to Nebula IP only - not accessible from public network
    # TODO: Update this IP to match your host's Nebula IP
    # Example for Host ID 1: 10.100.1.1
    listen 10.100.1.1:8080;

    # Internal server name
    server_name _;

    # Disable access log for internal API (optional, enable for debugging)
    access_log off;

    # Character encoding
    charset utf-8;

    #--------------------------------------------------------------------------
    # Container API Endpoints
    #--------------------------------------------------------------------------

    # Main container API
    # GET    /api/containers         - List all containers
    # GET    /api/containers/:id     - Get container by ID
    # POST   /api/containers         - Register container
    # DELETE /api/containers/:id     - Deregister container
    location /api/containers {
        # Set Lua package path for flatnet modules
        # Note: Adjust path based on your OpenResty installation
        set $flatnet_lualib "F:/flatnet/openresty/lualib";

        content_by_lua_file $flatnet_lualib/flatnet/api/containers.lua;
    }

    # Container API with ID parameter (captures ID in path)
    location ~ ^/api/containers/([a-zA-Z0-9_-]+)$ {
        set $flatnet_lualib "F:/flatnet/openresty/lualib";

        content_by_lua_file $flatnet_lualib/flatnet/api/containers.lua;
    }

    #--------------------------------------------------------------------------
    # Health and Status Endpoints
    #--------------------------------------------------------------------------

    # Simple health check
    location /api/health {
        default_type text/plain;
        return 200 'OK';
    }

    # Sync status (JSON)
    location /api/status {
        default_type application/json;

        content_by_lua_block {
            local cjson = require("cjson.safe")
            local registry = require("flatnet.registry")
            local sync = require("flatnet.sync")

            local status = {
                status = "running",
                service = "flatnet-gateway-api",
                stage = "3",
                registry = registry.stats(),
                sync = sync.status()
            }

            ngx.say(cjson.encode(status))
        }
    }

    #--------------------------------------------------------------------------
    # Container Lookup by IP (for routing)
    #--------------------------------------------------------------------------

    # GET /api/lookup/ip/:ip - Lookup container by IP
    location ~ ^/api/lookup/ip/([0-9.]+)$ {
        default_type application/json;

        set $lookup_ip $1;

        content_by_lua_block {
            local cjson = require("cjson.safe")
            local registry = require("flatnet.registry")

            local ip = ngx.var.lookup_ip
            local container = registry.get_by_ip(ip)

            if not container then
                ngx.status = 404
                ngx.say(cjson.encode({error = "not found", ip = ip}))
                return
            end

            ngx.say(cjson.encode(container))
        }
    }

    #--------------------------------------------------------------------------
    # Sync Control (for debugging/admin)
    #--------------------------------------------------------------------------

    # POST /api/sync/pull - Force pull from peers
    location = /api/sync/pull {
        default_type application/json;

        content_by_lua_block {
            local cjson = require("cjson.safe")
            local sync = require("flatnet.sync")

            if ngx.req.get_method() ~= "POST" then
                ngx.status = 405
                ngx.say(cjson.encode({error = "method not allowed"}))
                return
            end

            local success, failure = sync.pull_from_peers()
            ngx.say(cjson.encode({
                action = "pull",
                success_count = success,
                failure_count = failure
            }))
        }
    }

    #--------------------------------------------------------------------------
    # Error Pages
    #--------------------------------------------------------------------------

    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root F:/flatnet/openresty/html;
        internal;
    }
}

#==============================================================================
# Shared Dict Configuration Note
#==============================================================================
#
# Add this to the http block in nginx.conf:
#
#   # Shared memory for Flatnet container registry (10MB)
#   lua_shared_dict flatnet_containers 10m;
#
#   # Lua package path for Flatnet modules
#   lua_package_path "F:/flatnet/openresty/lualib/?.lua;;";
#
#==============================================================================
