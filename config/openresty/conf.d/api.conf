# Flatnet Gateway - Internal API Configuration
# Phase 3, Stage 3: CNI Plugin Multihost Extension
# Phase 3, Stage 4: Graceful Escalation
#
# This configuration provides:
# - Internal API for container registration (Nebula network only)
# - Container info lookup for routing decisions
# - Health check and sync status endpoints
# - Escalation state API (Stage 4)
# - Routing API (Stage 4)
# - Healthcheck status API (Stage 4)
#
# Usage:
#   This file should be included from nginx.conf
#   Requires shared dict configuration in main http block

#==============================================================================
# Internal API Server (Nebula Network Only)
#==============================================================================

# Note: The listen address should be the Nebula IP of this host.
# Replace 10.100.X.1 with your host's Nebula IP (X = host_id)
# This ensures the API is only accessible within the Nebula network.

server {
    # Bind to Nebula IP only - not accessible from public network
    # TODO: Update this IP to match your host's Nebula IP
    # Example for Host ID 1: 10.100.1.1
    listen 10.100.1.1:8080;

    # Internal server name
    server_name _;

    # Disable access log for internal API (optional, enable for debugging)
    access_log off;

    # Character encoding
    charset utf-8;

    #--------------------------------------------------------------------------
    # Container API Endpoints
    #--------------------------------------------------------------------------

    # Main container API
    # GET    /api/containers         - List all containers
    # GET    /api/containers/:id     - Get container by ID
    # POST   /api/containers         - Register container
    # DELETE /api/containers/:id     - Deregister container
    location /api/containers {
        # Set Lua package path for flatnet modules
        # Note: Adjust path based on your OpenResty installation
        set $flatnet_lualib "F:/flatnet/openresty/lualib";

        content_by_lua_file $flatnet_lualib/flatnet/api/containers.lua;
    }

    # Container API with ID parameter (captures ID in path)
    location ~ ^/api/containers/([a-zA-Z0-9_-]+)$ {
        set $flatnet_lualib "F:/flatnet/openresty/lualib";

        content_by_lua_file $flatnet_lualib/flatnet/api/containers.lua;
    }

    #--------------------------------------------------------------------------
    # Health and Status Endpoints
    #--------------------------------------------------------------------------

    # Simple health check
    location /api/health {
        default_type text/plain;
        return 200 'OK';
    }

    # Sync status (JSON)
    location /api/status {
        default_type application/json;

        content_by_lua_block {
            local cjson = require("cjson.safe")
            local registry = require("flatnet.registry")
            local sync = require("flatnet.sync")
            local escalation = require("flatnet.escalation")
            local routing = require("flatnet.routing")
            local healthcheck = require("flatnet.healthcheck")

            local status = {
                status = "running",
                service = "flatnet-gateway-api",
                stage = "4",
                registry = registry.stats(),
                sync = sync.status(),
                escalation = escalation.stats(),
                routing = routing.stats(),
                healthcheck = healthcheck.status()
            }

            ngx.say(cjson.encode(status))
        }
    }

    #--------------------------------------------------------------------------
    # Container Lookup by IP (for routing)
    #--------------------------------------------------------------------------

    # GET /api/lookup/ip/:ip - Lookup container by IP
    location ~ ^/api/lookup/ip/([0-9.]+)$ {
        default_type application/json;

        set $lookup_ip $1;

        content_by_lua_block {
            local cjson = require("cjson.safe")
            local registry = require("flatnet.registry")

            local ip = ngx.var.lookup_ip
            local container = registry.get_by_ip(ip)

            if not container then
                ngx.status = 404
                ngx.say(cjson.encode({error = "not found", ip = ip}))
                return
            end

            ngx.say(cjson.encode(container))
        }
    }

    #--------------------------------------------------------------------------
    # Sync Control (for debugging/admin)
    #--------------------------------------------------------------------------

    # POST /api/sync/pull - Force pull from peers
    location = /api/sync/pull {
        default_type application/json;

        content_by_lua_block {
            local cjson = require("cjson.safe")
            local sync = require("flatnet.sync")

            if ngx.req.get_method() ~= "POST" then
                ngx.status = 405
                ngx.say(cjson.encode({error = "method not allowed"}))
                return
            end

            local success, failure = sync.pull_from_peers()
            ngx.say(cjson.encode({
                action = "pull",
                success_count = success,
                failure_count = failure
            }))
        }
    }

    #--------------------------------------------------------------------------
    # Escalation API Endpoints (Phase 3, Stage 4)
    #--------------------------------------------------------------------------

    # GET /api/escalation/state?ip=<ip> - Get escalation state for an IP
    location /api/escalation/state {
        default_type application/json;

        content_by_lua_block {
            local cjson = require("cjson.safe")
            local escalation = require("flatnet.escalation")

            local ip = ngx.var.arg_ip
            if not ip then
                ngx.status = 400
                ngx.say(cjson.encode({error = "ip parameter required"}))
                return
            end

            local state = escalation.get_state(ip)
            local metadata = escalation.get_metadata(ip)
            local latency = escalation.get_latency(ip)
            local retry_count = escalation.get_retry_count(ip)
            local last_check = escalation.get_last_check(ip)

            ngx.say(cjson.encode({
                ip = ip,
                state = state,
                metadata = metadata,
                latency = latency,
                retry_count = retry_count,
                last_check = last_check
            }))
        }
    }

    # GET /api/escalation/states - Get all escalation states
    location = /api/escalation/states {
        default_type application/json;

        content_by_lua_block {
            local cjson = require("cjson.safe")
            local escalation = require("flatnet.escalation")

            ngx.say(cjson.encode(escalation.get_all_states()))
        }
    }

    # GET /api/escalation/stats - Get escalation statistics
    location = /api/escalation/stats {
        default_type application/json;

        content_by_lua_block {
            local cjson = require("cjson.safe")
            local escalation = require("flatnet.escalation")

            ngx.say(cjson.encode(escalation.stats()))
        }
    }

    # POST /api/escalation/attempt?ip=<ip> - Manually trigger P2P attempt
    location = /api/escalation/attempt {
        default_type application/json;

        content_by_lua_block {
            local cjson = require("cjson.safe")
            local escalation = require("flatnet.escalation")

            if ngx.req.get_method() ~= "POST" then
                ngx.status = 405
                ngx.say(cjson.encode({error = "method not allowed"}))
                return
            end

            local ip = ngx.var.arg_ip
            if not ip then
                ngx.status = 400
                ngx.say(cjson.encode({error = "ip parameter required"}))
                return
            end

            local ok, err = escalation.attempt_p2p(ip, ngx.var.arg_gateway)
            if ok then
                ngx.say(cjson.encode({
                    success = true,
                    ip = ip,
                    state = escalation.get_state(ip)
                }))
            else
                ngx.status = 400
                ngx.say(cjson.encode({error = err}))
            end
        }
    }

    # POST /api/escalation/reset?ip=<ip> - Reset escalation state
    location = /api/escalation/reset {
        default_type application/json;

        content_by_lua_block {
            local cjson = require("cjson.safe")
            local escalation = require("flatnet.escalation")

            if ngx.req.get_method() ~= "POST" then
                ngx.status = 405
                ngx.say(cjson.encode({error = "method not allowed"}))
                return
            end

            local ip = ngx.var.arg_ip
            if not ip then
                ngx.status = 400
                ngx.say(cjson.encode({error = "ip parameter required"}))
                return
            end

            escalation.clear(ip)
            ngx.say(cjson.encode({
                success = true,
                ip = ip,
                state = escalation.get_state(ip)
            }))
        }
    }

    #--------------------------------------------------------------------------
    # Routing API Endpoints (Phase 3, Stage 4)
    #--------------------------------------------------------------------------

    # GET /api/routing/route?ip=<ip> - Get route for an IP
    location /api/routing/route {
        default_type application/json;

        content_by_lua_block {
            local cjson = require("cjson.safe")
            local routing = require("flatnet.routing")

            local ip = ngx.var.arg_ip
            if not ip then
                ngx.status = 400
                ngx.say(cjson.encode({error = "ip parameter required"}))
                return
            end

            -- Skip P2P attempt for API queries
            local route = routing.get_route(ip, {skip_p2p_attempt = true})
            ngx.say(cjson.encode(route))
        }
    }

    # GET /api/routing/routes - Get all routes
    location = /api/routing/routes {
        default_type application/json;

        content_by_lua_block {
            local cjson = require("cjson.safe")
            local routing = require("flatnet.routing")

            ngx.say(cjson.encode(routing.get_all_routes()))
        }
    }

    # GET /api/routing/stats - Get routing statistics
    location = /api/routing/stats {
        default_type application/json;

        content_by_lua_block {
            local cjson = require("cjson.safe")
            local routing = require("flatnet.routing")

            ngx.say(cjson.encode(routing.stats()))
        }
    }

    #--------------------------------------------------------------------------
    # Healthcheck API Endpoints (Phase 3, Stage 4)
    #--------------------------------------------------------------------------

    # GET /api/healthcheck/status - Get healthcheck status
    location = /api/healthcheck/status {
        default_type application/json;

        content_by_lua_block {
            local cjson = require("cjson.safe")
            local healthcheck = require("flatnet.healthcheck")

            ngx.say(cjson.encode(healthcheck.status()))
        }
    }

    # POST /api/healthcheck/check?ip=<ip> - Manually trigger healthcheck
    location = /api/healthcheck/check {
        default_type application/json;

        content_by_lua_block {
            local cjson = require("cjson.safe")
            local healthcheck = require("flatnet.healthcheck")

            if ngx.req.get_method() ~= "POST" then
                ngx.status = 405
                ngx.say(cjson.encode({error = "method not allowed"}))
                return
            end

            local ip = ngx.var.arg_ip
            if not ip then
                ngx.status = 400
                ngx.say(cjson.encode({error = "ip parameter required"}))
                return
            end

            local success, latency, err = healthcheck.check(ip)
            ngx.say(cjson.encode({
                ip = ip,
                success = success,
                latency_ms = latency,
                error = err
            }))
        }
    }

    # POST /api/healthcheck/enable - Enable healthcheck
    location = /api/healthcheck/enable {
        default_type application/json;

        content_by_lua_block {
            local cjson = require("cjson.safe")
            local healthcheck = require("flatnet.healthcheck")

            if ngx.req.get_method() ~= "POST" then
                ngx.status = 405
                ngx.say(cjson.encode({error = "method not allowed"}))
                return
            end

            healthcheck.enable()
            ngx.say(cjson.encode({success = true, enabled = true}))
        }
    }

    # POST /api/healthcheck/disable - Disable healthcheck
    location = /api/healthcheck/disable {
        default_type application/json;

        content_by_lua_block {
            local cjson = require("cjson.safe")
            local healthcheck = require("flatnet.healthcheck")

            if ngx.req.get_method() ~= "POST" then
                ngx.status = 405
                ngx.say(cjson.encode({error = "method not allowed"}))
                return
            end

            healthcheck.disable()
            ngx.say(cjson.encode({success = true, enabled = false}))
        }
    }

    #--------------------------------------------------------------------------
    # Error Pages
    #--------------------------------------------------------------------------

    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root F:/flatnet/openresty/html;
        internal;
    }
}

#==============================================================================
# Shared Dict Configuration Note
#==============================================================================
#
# Add this to the http block in nginx.conf:
#
#   # Shared memory for Flatnet container registry (10MB)
#   lua_shared_dict flatnet_containers 10m;
#
#   # Lua package path for Flatnet modules
#   lua_package_path "F:/flatnet/openresty/lualib/?.lua;;";
#
#==============================================================================
