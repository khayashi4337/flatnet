# Flatnet Gateway - OpenResty Configuration
# Phase 1, Stage 2: WSL2 Proxy Configuration
# Phase 2, Stage 4: Gateway Integration
# Phase 3, Stage 3: CNI Plugin Multihost Extension
#
# This configuration provides:
# - Basic HTTP server on port 80
# - Health check endpoint at /health
# - Proxy to WSL2 services at /wsl2/
# - WebSocket support at /wsl2-ws/
# - Static file serving from OpenResty html directory
# - Logging to F:/flatnet/logs/
# - Flatnet container proxying (via conf.d/flatnet.conf)
# - Internal API for container registration (via conf.d/api.conf)
#
# Usage:
#   Deploy: ./scripts/deploy-config.sh
#   Update IP: ./scripts/update-upstream.sh --reload
#   Test:   F:\flatnet\openresty\nginx.exe -c F:\flatnet\config\nginx.conf -t
#   Start:  F:\flatnet\openresty\nginx.exe -c F:\flatnet\config\nginx.conf
#   Reload: F:\flatnet\openresty\nginx.exe -c F:\flatnet\config\nginx.conf -s reload
#   Stop:   F:\flatnet\openresty\nginx.exe -c F:\flatnet\config\nginx.conf -s stop

#==============================================================================
# Core Settings
#==============================================================================

# Number of worker processes
# For Windows, auto detection may not work properly, so we explicitly set 1
# Increase this value if handling many concurrent connections
worker_processes 1;

# Error log configuration
# Levels: debug, info, notice, warn, error, crit, alert, emerg
error_log F:/flatnet/logs/error.log info;

# PID file location
pid F:/flatnet/logs/nginx.pid;

#==============================================================================
# Events Block
#==============================================================================

events {
    # Maximum number of simultaneous connections per worker
    # Windows: select() method is used, so this should be kept reasonable
    worker_connections 1024;
}

#==============================================================================
# HTTP Block
#==============================================================================

http {
    #--------------------------------------------------------------------------
    # Lua Configuration (Phase 3)
    #--------------------------------------------------------------------------

    # Lua package path for Flatnet modules
    lua_package_path "F:/flatnet/openresty/lualib/?.lua;F:/flatnet/config/lualib/?.lua;;";

    # Shared memory for Flatnet container registry (10MB)
    lua_shared_dict flatnet_containers 10m;

    # Initialize Flatnet sync on worker start
    init_worker_by_lua_block {
        local sync = require("flatnet.sync")
        -- Configure sync with peer endpoints (update with actual peer IPs)
        sync.configure({
            host_id = 1,  -- Update with this host's ID
            peers = {},   -- Add peer Gateway URLs: {"http://10.100.2.1:8080", ...}
            sync_interval = 30,
            sync_ttl = 300
        })
        sync.start_sync_timer()
    }

    #--------------------------------------------------------------------------
    # Basic Settings
    #--------------------------------------------------------------------------

    # Include MIME types from OpenResty installation
    include F:/flatnet/openresty/conf/mime.types;
    default_type application/octet-stream;

    # Access log configuration
    access_log F:/flatnet/logs/access.log;

    # Optimize file transfer
    sendfile on;

    # Keep-alive settings
    keepalive_timeout 65;

    # Server tokens - hide version for security
    server_tokens off;

    #--------------------------------------------------------------------------
    # Gzip Compression (optional, for better performance)
    #--------------------------------------------------------------------------

    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;
    gzip_min_length 1000;

    #--------------------------------------------------------------------------
    # Connection Upgrade Map (for WebSocket)
    #--------------------------------------------------------------------------

    # Map for handling WebSocket upgrade header
    # Used by flatnet.conf and forgejo.conf for WebSocket connections
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    #--------------------------------------------------------------------------
    # WSL2 Upstream Definition
    #--------------------------------------------------------------------------

    # WSL2 backend server
    # IP address is updated by scripts/update-upstream.sh
    # Do not manually edit the IP - use the script instead
    upstream wsl2_backend {
        server 172.0.0.1:8080;  # Placeholder - updated by update-upstream.sh
    }

    #--------------------------------------------------------------------------
    # Default Server
    #--------------------------------------------------------------------------

    server {
        # Listen on port 80 for all interfaces
        # This allows access from LAN
        listen 80;

        # Server name (localhost for now, can be changed later)
        server_name localhost;

        # Character encoding
        charset utf-8;

        #----------------------------------------------------------------------
        # Root Location - Static Files
        #----------------------------------------------------------------------

        location / {
            root F:/flatnet/openresty/html;
            index index.html index.htm;
        }

        #----------------------------------------------------------------------
        # Health Check Endpoint
        #----------------------------------------------------------------------

        # Simple health check for monitoring and testing
        # Returns 200 OK with plain text "OK"
        location /health {
            access_log off;  # Don't log health checks
            default_type text/plain;
            return 200 'OK';
        }

        #----------------------------------------------------------------------
        # Status Endpoint (for debugging)
        #----------------------------------------------------------------------

        # Returns basic server information
        # Only accessible from localhost for security
        location /status {
            # Restrict to localhost only (IPv4 and IPv6)
            allow 127.0.0.1;
            allow ::1;
            deny all;

            access_log off;
            default_type application/json;
            return 200 '{"status":"running","service":"flatnet-gateway","phase":"2","stage":"4"}';
        }

        #----------------------------------------------------------------------
        # WSL2 Proxy - Standard HTTP
        #----------------------------------------------------------------------

        # Proxy requests to WSL2 backend
        # Access: http://localhost/wsl2/
        location /wsl2/ {
            include F:/flatnet/config/conf.d/proxy-params.conf;
            proxy_pass http://wsl2_backend/;
        }

        #----------------------------------------------------------------------
        # WSL2 Proxy - WebSocket Support
        #----------------------------------------------------------------------

        # WebSocket-enabled proxy for Forgejo, etc.
        # Access: http://localhost/wsl2-ws/
        location /wsl2-ws/ {
            include F:/flatnet/config/conf.d/proxy-params.conf;
            include F:/flatnet/config/conf.d/websocket-params.conf;
            proxy_pass http://wsl2_backend/;
        }

        #----------------------------------------------------------------------
        # Error Pages
        #----------------------------------------------------------------------

        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
            root F:/flatnet/openresty/html;
        }
    }

    #--------------------------------------------------------------------------
    # Include Additional Configurations
    #--------------------------------------------------------------------------

    # Include Flatnet container proxy configuration
    # This adds server blocks for Flatnet services (forgejo, etc.)
    include F:/flatnet/config/conf.d/flatnet.conf;

    # Include Internal API configuration (Phase 3)
    # This adds the container registry API for multihost routing
    include F:/flatnet/config/conf.d/api.conf;
}
