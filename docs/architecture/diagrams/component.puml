@startuml component
!theme plain
title Flatnet - Component Diagram (C4 Level 3)

note as N1
  **設計判断: Gateway と Nebula Lighthouse の関係**
  - OpenResty (HTTP/L7) と Nebula Lighthouse (UDP) は別プロセス
  - デプロイ単位としてはセットで動く（同一 Windows ホスト上）
  - 外部クライアントからは "Flatnet Gateway" として見える
  - Nebula の存在はクライアントに露出しない（カプセル化）
end note

note as N2
  **Lighthouse 方針**
  既存の Nebula Lighthouse を利用する。
  - Phase 1-2: 不要（ローカル WSL2 のみ）
  - Phase 3: 導入（マルチホスト対応時）
end note

package "Flatnet Gateway (Host Windows)" as gateway_pkg {

  package "OpenResty (HTTP/L7)" as resty_pkg {
    class Gateway {
      +handle_request(req): Response
      +resolve_backend(host): FlatnetIP
      +proxy_pass(req, backend_ip): Response
    }

    class LuaRouter {
      +route(req): UpstreamConfig
      +query_lighthouse(hostname): FlatnetIP
      +health_check(backend): bool
    }

    Gateway --> LuaRouter : ルーティング判定
  }

  package "Nebula Lighthouse (UDP)" as lighthouse_pkg #LightGray {
    class Lighthouse <<external>> {
      +register_node(node_id, flatnet_ip, endpoint): void
      +lookup_node(node_id): FlatnetIP
      +list_nodes(): Node[]
      +handle_punch(src, dst): void
    }

    note bottom of Lighthouse
      既存の Nebula Lighthouse を利用
      Phase 3 で導入予定
    end note
  }

  LuaRouter --> Lighthouse : ノード解決\n(Phase 3)
}

package "WSL2" as wsl_pkg {

  package "Flatnet CNI Plugin (Rust)" as cni_pkg {
    class FlatnetCNI {
      +add(container_id, netns): CNIResult
      +del(container_id, netns): CNIResult
      +check(container_id, netns): CNIResult
    }

    class NetworkNamespace {
      +create_interface(netns_path): Device
      +assign_ip(device, ip): void
      +setup_routes(device, routes): void
      +teardown(netns_path): void
    }

    class IPAddressManager {
      +allocate_ip(container_id): FlatnetIP
      +release_ip(container_id): void
    }

    FlatnetCNI --> NetworkNamespace
    FlatnetCNI --> IPAddressManager
  }

  package "Nebula Client (Phase 3)" as nebula_client_pkg #LightGray {
    class NebulaClient <<external>> {
      +connect_to_lighthouse(): void
      +create_tunnel(): Tunnel
    }

    note bottom of NebulaClient
      Phase 3 で導入予定
      CNI Plugin と連携
    end note
  }

  cni_pkg ..> nebula_client_pkg : Phase 3 で連携
}

nebula_client_pkg --> lighthouse_pkg : Nebula プロトコル\n(Phase 3)

note as N3
  **Phase 別の構成**
  Phase 1: OpenResty → WSL2 (直接プロキシ)
  Phase 2: OpenResty → CNI Plugin (IP 自動管理)
  Phase 3: + Nebula Lighthouse/Client (マルチホスト)
end note

note bottom of gateway_pkg
  社内メンバーは HTTP のみで
  Flatnet 内のサービスにアクセス可能
  （Nebula インストール不要）
end note
@enduml
