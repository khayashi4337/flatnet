# 設計ノート: フォールバック戦略

## 背景

e4mc の調査から、P2P 接続失敗時のフォールバックがないことが弱点として判明。
Flatnet ではこれを改善し、常に接続可能な状態を維持する。

## 設計原則

```
信頼性 > 最適化
```

P2P による低遅延化は「あれば嬉しい」最適化であり、
Gateway 経由の確実な接続が常に優先される。

## フォールバック戦略案

### 案 A: Dual-Path（二重経路維持）

```
Gateway
├── Primary:   P2P トンネル（確立済みの場合）
└── Secondary: 通常トンネル（常時維持）

切り替え条件:
- P2P 側のヘルスチェック失敗
- レイテンシ閾値超過
- パケットロス検出
```

**メリット:**
- 瞬時のフォールバック（切り替え済み経路）
- クライアントから完全に透過

**デメリット:**
- リソース消費（2経路分）
- 実装複雑性

### 案 B: Graceful Escalation（段階的昇格）

```
初期接続: Gateway 経由（確実）
     ↓
バックグラウンド: P2P 経路を確立試行
     ↓
成功時: P2P に切り替え（Gateway は待機）
     ↓
失敗検出: Gateway に即時フォールバック
```

**メリット:**
- 初期接続が必ず成功
- リソース効率が良い

**デメリット:**
- 初期接続は最適化されない
- 切り替え時に一瞬の遅延

### 案 C: Hybrid（ハイブリッド）

```
制御プレーン: 常に Gateway 経由
データプレーン: P2P 優先、失敗時 Gateway
```

e4mc に近いが、データプレーンにもフォールバックを追加。

**メリット:**
- e4mc の良い部分を継承
- 制御と データの分離が明確

**デメリット:**
- 2 種類の経路管理が必要

## 推奨: 案 B（Graceful Escalation）

理由:
1. 初期接続の確実性が最優先
2. P2P はバックグラウンド最適化として扱える
3. 実装がシンプル
4. Flatnet の「クライアントは HTTP のみ」原則と整合

## 実装イメージ

```
[Client] ──HTTP──→ [Gateway]
                      │
                      ├── 即時: WSL2 Daemon 経由でコンテナへ
                      │         (通常経路、常に動作)
                      │
                      └── 非同期: P2P 経路を確立試行
                                  成功したら切り替え
                                  失敗しても問題なし
```

## 状態遷移

```
[CONNECTING]
     │
     ▼
[GATEWAY_ONLY] ←─────────────────┐
     │                           │
     │ P2P試行成功               │ P2P失敗/タイムアウト
     ▼                           │
[P2P_ACTIVE] ────────────────────┘
     │
     │ P2P障害検出
     ▼
[GATEWAY_FALLBACK] → [GATEWAY_ONLY]
```

## 未決定事項

- [ ] P2P 障害検出の閾値（レイテンシ、パケットロス）
- [ ] フォールバック時のセッション維持方法
- [ ] P2P 再試行のバックオフ戦略

**注記**: これらの詳細は Phase 3 Stage 4 で決定・実装される。
詳細は [Phase 3 Stage 4: Graceful Escalation 実装](../../phases/phase-3/stage-4-graceful-escalation.md) を参照。

## 関連ドキュメント

- [e4mc 調査](../research/e4mc-analysis.md)
- [component.puml](../diagrams/component.puml)
- [Phase 3: マルチホスト対応](../../phases/phase-3/README.md)
