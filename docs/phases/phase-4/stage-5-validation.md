# Stage 5: 連続運用テスト

## 概要

1週間の連続運用テストを実施し、システムの安定性を検証する。負荷テストで限界を確認し、発見された問題を対処して本番運用に備える。

## ブランチ戦略

- ブランチ名: `phase4/stage-5-validation`
- マージ先: `master`

## インプット（前提条件）

- Stage 1-4（監視・ログ・セキュリティ・運用手順書）が完了している
- システムが一通り構築・設定済み
- 運用手順書が整備されている

## 目標

- 1週間の連続運用で重大な問題がないことを確認する
- 負荷テストでシステムの限界を把握する
- 発見された問題を対処または記録する
- 本番運用開始の判断材料を得る

## 手段

- 1週間の連続運用テスト実施
- 負荷テストツールによる限界確認
- 問題発生時の対処と記録
- 運用テストレポートの作成

---

## Sub-stages

### Sub-stage 5.1: テスト計画策定

**内容:**
- テスト期間・スケジュールの決定
- テストシナリオの定義
- 成功基準の設定
- 監視項目の確認

**テスト期間:**
- 開始: YYYY/MM/DD
- 終了: YYYY/MM/DD（7日間）

**テストシナリオ:**

| シナリオ | 内容 | 頻度 |
|---------|------|------|
| 通常利用 | ブラウザから Forgejo にアクセス | 常時 |
| Git 操作 | clone, push, pull | 日次 |
| コンテナ操作 | 起動、停止、再作成 | 日次 |
| 監視確認 | ダッシュボード確認 | 日次 |
| ログ検索 | エラーログの検索 | 日次 |
| 再起動テスト | WSL2/Windows 再起動 | 1回 |

**成功基準:**

| 項目 | 基準 |
|------|------|
| 可用性 | 99% 以上（計画停止除く） |
| エラーレート | 1% 未満 |
| 重大障害 | 0件 |
| レスポンスタイム（p95） | 1秒未満 |

**完了条件:**
- [ ] テスト計画が作成されている
- [ ] テストシナリオが定義されている
- [ ] 成功基準が設定されている

---

### Sub-stage 5.2: 連続運用テスト実施

**内容:**
- 7日間の連続運用
- 日次の状態確認
- 問題発生時の記録と対処

**日次確認チェックリスト:**

```markdown
## Day X 確認 (YYYY/MM/DD)

### システム状態
- [ ] Gateway 稼働中
- [ ] CNI Plugin 正常動作
- [ ] 監視スタック稼働中

### メトリクス確認
- [ ] CPU 使用率: ____%
- [ ] メモリ使用率: ____%
- [ ] ディスク使用率: ____%
- [ ] リクエスト数（過去24h）: ____
- [ ] エラー数（過去24h）: ____

### ログ確認
- [ ] エラーログ確認済み
- [ ] 異常なログなし

### 問題・気づき
- (記載)

### 確認者
- 名前: ____
- 時刻: ____
```

**問題記録テンプレート:**

```markdown
## 問題 #XX

### 発生日時
YYYY/MM/DD HH:MM

### 症状
（詳細を記載）

### 影響
- 影響範囲:
- ダウンタイム:

### 原因
（判明している場合）

### 対処
（実施した対処）

### ステータス
- [ ] 解決済み
- [ ] 対処中
- [ ] 要調査

### 備考
```

**完了条件:**
- [ ] 7日間の運用テストが完了している
- [ ] 日次確認が毎日実施されている
- [ ] 発生した問題が記録されている

---

### Sub-stage 5.3: 負荷テスト

**内容:**
- 負荷テストツールの準備
- 段階的な負荷テスト実施
- 限界値の特定

**負荷テストツール:**
- `wrk` または `hey` を使用

```bash
# wrk インストール (Ubuntu - ソースからビルド)
sudo apt install build-essential libssl-dev git
git clone https://github.com/wg/wrk.git
cd wrk && make && sudo cp wrk /usr/local/bin/

# hey インストール (Go がインストール済みの場合)
go install github.com/rakyll/hey@latest

# または hey をバイナリで取得
wget https://hey-release.s3.us-east-2.amazonaws.com/hey_linux_amd64
chmod +x hey_linux_amd64 && sudo mv hey_linux_amd64 /usr/local/bin/hey
```

**負荷テストシナリオ:**

1. ベースライン測定（10同時接続、30秒）
   ```bash
   # <WINDOWS_IP> は Gateway が動作する Windows の IP アドレス
   wrk -t2 -c10 -d30s http://<WINDOWS_IP>/
   ```

2. 中負荷テスト（50同時接続、60秒）
   ```bash
   wrk -t4 -c50 -d60s http://<WINDOWS_IP>/
   ```

3. 高負荷テスト（100同時接続、60秒）
   ```bash
   wrk -t8 -c100 -d60s http://<WINDOWS_IP>/
   ```

4. 限界テスト（200同時接続、60秒）
   ```bash
   wrk -t8 -c200 -d60s http://<WINDOWS_IP>/
   ```

**注意:** 負荷テストは WSL2 内から実行するか、社内 LAN の別マシンから実行する。WSL2 から Windows へのアクセスは `$(cat /etc/resolv.conf | grep nameserver | awk '{print $2}')` で IP を取得可能。

**測定項目:**

| 項目 | 測定方法 |
|------|---------|
| スループット（RPS） | wrk 出力 |
| レイテンシ（avg/p50/p99） | wrk 出力 |
| エラーレート | wrk 出力 + ログ |
| CPU 使用率 | Grafana |
| メモリ使用率 | Grafana |

**負荷テスト結果テンプレート:**

```markdown
## 負荷テスト結果

### テスト条件
- 日時: YYYY/MM/DD HH:MM
- 対象: Gateway (http://xxx/)
- ツール: wrk

### 結果サマリー

| 同時接続 | RPS | Latency (avg) | Latency (p99) | Error Rate |
|---------|-----|---------------|---------------|------------|
| 10 | | | | |
| 50 | | | | |
| 100 | | | | |
| 200 | | | | |

### 限界値
- 推奨同時接続数: ____
- 最大スループット: ____ RPS

### ボトルネック
- (CPU/メモリ/ネットワーク/アプリケーション)

### 推奨事項
- (記載)
```

**完了条件:**
- [ ] 負荷テストが実施されている
- [ ] 各負荷レベルの結果が記録されている
- [ ] 限界値が特定されている
- [ ] ボトルネックが分析されている

---

### Sub-stage 5.4: 問題対処

**内容:**
- 発見された問題の分類
- 重要度に応じた対処
- 対処できない問題の記録

**問題分類:**

| 重要度 | 定義 | 対処 |
|--------|------|------|
| Critical | サービス停止 | 本番前に必ず対処 |
| High | 機能に重大な影響 | 本番前に対処（または緩和策） |
| Medium | 機能に軽微な影響 | 運用開始後に対処可 |
| Low | 改善事項 | バックログに追加 |

**既知の問題リスト（テンプレート）:**

```markdown
## 既知の問題一覧

### Critical
- (なし)

### High
- (なし)

### Medium
- #XX: (問題の概要) - 対処予定: YYYY/MM/DD

### Low
- #XX: (問題の概要) - バックログに追加
```

**完了条件:**
- [ ] 発見された問題が分類されている
- [ ] Critical/High 問題が対処されている
- [ ] 未対処の問題が既知の問題として記録されている

---

### Sub-stage 5.5: 運用テストレポート作成

**内容:**
- テスト結果のまとめ
- 成功基準との比較
- 本番運用開始の判断
- 今後の改善事項

**運用テストレポート構成:**

```markdown
# 連続運用テストレポート

## エグゼクティブサマリー
- テスト期間: YYYY/MM/DD - YYYY/MM/DD
- 結果: 合格/不合格
- 本番運用開始: 推奨する/推奨しない

## テスト概要
- 目的
- 期間
- テストシナリオ

## 結果サマリー

### 成功基準との比較

| 項目 | 基準 | 実績 | 判定 |
|------|------|------|------|
| 可用性 | 99% 以上 | ___% | OK/NG |
| エラーレート | 1% 未満 | ___% | OK/NG |
| 重大障害 | 0件 | ___件 | OK/NG |
| レスポンスタイム | 1秒未満 | ___秒 | OK/NG |

### 日次サマリー

| 日 | 状態 | 問題 | 備考 |
|----|------|------|------|
| Day 1 | OK | なし | |
| Day 2 | OK | なし | |
| ... | | | |

## 負荷テスト結果
- 最大スループット: ___ RPS
- 推奨同時接続数: ___
- ボトルネック: ___

## 発生した問題
- 問題一覧
- 対処状況

## 既知の問題
- 未対処の問題一覧
- リスク評価

## 今後の改善事項
- (記載)

## 結論
- 本番運用開始の可否
- 条件付きの場合の条件
- 次のアクション
```

**完了条件:**
- [ ] 運用テストレポートが作成されている
- [ ] 成功基準との比較が記載されている
- [ ] 本番運用開始の判断が記載されている
- [ ] 関係者にレポートが共有されている

---

## 成果物

- `docs/operations/test-plan.md` - テスト計画
- `docs/operations/daily-logs/` - 日次確認記録
- `docs/operations/load-test-report.md` - 負荷テスト結果
- `docs/operations/validation-report.md` - 運用テストレポート
- `docs/operations/known-issues.md` - 既知の問題一覧

## 完了条件

- [ ] 7日間の連続運用テストが完了している
- [ ] 成功基準を満たしている
- [ ] 負荷テストが完了し、限界が把握されている
- [ ] 発見された問題が対処または記録されている
- [ ] 運用テストレポートが作成・共有されている
- [ ] 本番運用開始の判断がなされている

## 参考情報

### 負荷テストツール比較

| ツール | 特徴 | インストール |
|--------|------|-------------|
| wrk | 軽量、高性能 | `apt install wrk` |
| hey | Go 製、使いやすい | `go install github.com/rakyll/hey@latest` |
| k6 | スクリプト対応、高機能 | `brew install k6` |
| ab | Apache 付属、シンプル | `apt install apache2-utils` |

### 可用性の計算

```
可用性 = (総時間 - ダウンタイム) / 総時間 * 100

例: 7日間（168時間）で1時間のダウンタイム
可用性 = (168 - 1) / 168 * 100 = 99.4%
```

### 次のステップ

運用テストが合格した場合:
1. 本番運用開始の告知
2. 本番データの移行（必要な場合）
3. 運用体制の確立
4. 定期的な運用レビューの開始
