# Phase 4: 本番運用準備

## ゴール

Flatnet を本番環境で安定運用できる状態にする。監視・ログ収集基盤を整備し、セキュリティを強化し、運用手順書を完備する。

## スコープ

**含まれるもの:**
- 監視基盤の構築（メトリクス収集、アラート）
- ログ収集・分析基盤の構築
- セキュリティ監査と強化
- 運用手順書の作成（日常運用、障害対応）
- 連続運用テストによる安定性検証

**含まれないもの:**
- 機能追加・拡張 → Phase 5 以降で検討
- 大規模スケールアウト対応 → 別途検討

## Phase 4 完了条件

- [ ] 監視ダッシュボードで Gateway と CNI Plugin の状態が可視化されている
- [ ] アラートが適切に設定され、障害時に通知される
- [ ] ログが集約され、検索・分析が可能
- [ ] セキュリティ監査を実施し、重大な問題がない
- [ ] 運用手順書（日常運用、障害対応、バックアップ/リストア）が完成
- [ ] 1週間の連続運用テストを完了し、問題なし

---

## Stages

### Stage 1: 監視基盤構築

**概要**
- Prometheus によるメトリクス収集
- Grafana ダッシュボード構築
- アラート設定（Alertmanager）

**完了条件**
- [ ] Gateway/CNI の主要メトリクスが収集されている
- [ ] Grafana でシステム状態を可視化できる
- [ ] 障害時にアラートが発報される

詳細: [stage-1-monitoring.md](./stage-1-monitoring.md)

---

### Stage 2: ログ収集・分析

**概要**
- 集中ログ管理基盤の構築
- ログローテーションとリテンション設定
- ログ検索・分析機能

**完了条件**
- [ ] Gateway/CNI/コンテナのログが集約されている
- [ ] ログの検索・フィルタリングが可能
- [ ] ログローテーションが適切に設定されている

詳細: [stage-2-logging.md](./stage-2-logging.md)

---

### Stage 3: セキュリティ強化

**概要**
- セキュリティ監査の実施
- アクセス制御の強化
- 脆弱性対策と定期スキャン設定

**完了条件**
- [ ] セキュリティ監査を実施し、レポートを作成
- [ ] 重大な脆弱性が対処されている
- [ ] アクセス制御ポリシーが文書化・適用されている

詳細: [stage-3-security.md](./stage-3-security.md)

---

### Stage 4: 運用手順書作成

**概要**
- 日常運用手順書
- 障害対応手順書（ランブック）
- バックアップ・リストア手順書

**完了条件**
- [ ] 日常運用手順書が完成
- [ ] 障害対応手順書（よくある障害パターン別）が完成
- [ ] バックアップ・リストア手順がテスト済み

詳細: [stage-4-operations.md](./stage-4-operations.md)

---

### Stage 5: 連続運用テスト

**概要**
- 1週間の連続運用テスト
- 負荷テストによる限界確認
- 問題点の洗い出しと対処

**完了条件**
- [ ] 1週間の連続運用で重大な問題なし
- [ ] 負荷テスト結果がドキュメント化されている
- [ ] 発見された問題が対処または記録されている

詳細: [stage-5-validation.md](./stage-5-validation.md)

---

## 成果物

- 監視ダッシュボード（Grafana）設定ファイル
- アラートルール設定
- ログ収集設定ファイル
- セキュリティ監査レポート
- 運用手順書一式
- 連続運用テストレポート

## 技術選定

### 監視スタック

```
[Prometheus] ←── scrape ──→ [Gateway: metrics endpoint]
     │                      [CNI: metrics endpoint]
     │                      [Node Exporter]
     ▼
[Alertmanager] → 通知（Slack/Email）
     │
     ▼
[Grafana] ←── query ── ダッシュボード表示
```

### ログスタック

```
[Gateway/CNI/Containers]
     │
     ▼ ログ出力
[Loki] または [Elasticsearch]
     │
     ▼
[Grafana] でログ検索・可視化
```

軽量運用を優先し、Loki + Grafana を推奨。Elasticsearch は大規模環境向け。

## 前提条件

- Phase 1-3 が完了していること（または Phase 2 で十分な場合）
- Podman 環境が安定稼働していること
- 監視用リソース（CPU/メモリ/ストレージ）が確保されていること

## Phase 依存関係

```
Phase 4 の前提:
├── Phase 1: Gateway 基盤 → 必須
├── Phase 2: CNI Plugin → 必須（コンテナ自動化なしでは運用が困難）
└── Phase 3: マルチホスト → オプション（シングルホスト運用なら不要）

判断基準:
- シングルホスト運用: Phase 1-2 完了後に Phase 4 開始可能
- マルチホスト運用: Phase 3 完了後に Phase 4 開始
```

## 環境の特殊性

Flatnet は Windows + WSL2 のハイブリッド環境で動作するため、監視・ログ収集には以下の考慮が必要:

| コンポーネント | 動作環境 | 考慮事項 |
|---------------|---------|---------|
| Gateway (OpenResty) | Windows | Windows のログ形式、パス |
| CNI Plugin | WSL2 | Linux 形式 |
| Podman コンテナ | WSL2 | Podman ログドライバー |
| 監視スタック | WSL2 | Windows 側へのアクセス |

## リモートメンバー対応（オプション）

Phase 4 では、リモートメンバーからのアクセス対応も検討可能:

- VPN 経由でのアクセス（既存インフラ活用）
- Gateway への認証機能追加
- アクセスログによる利用状況把握

注: 本格的なリモートアクセスは Phase 3（マルチホスト対応）で実現される。Phase 4 では VPN 等の既存インフラを活用した簡易対応のみ。

## 関連ドキュメント

- [ロードマップ（全体）](../README.md)
- [Phase 1: Gateway 基盤](../phase-1/README.md)
- [アーキテクチャ図](../../architecture/diagrams/component.puml)
