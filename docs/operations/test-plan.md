# Flatnet 連続運用テスト計画

Phase 4, Stage 5: Validation

## 1. 概要

### 1.1 目的

本テスト計画は、Flatnet システムの本番運用開始前に以下を確認することを目的とする:

- システムの安定性（7日間の連続運用）
- パフォーマンス特性（負荷テストによる限界把握）
- 運用手順の妥当性（実運用に近い操作の検証）

### 1.2 スコープ

| 対象 | 含む | 含まない |
|------|------|----------|
| Gateway (OpenResty) | HTTP プロキシ、ルーティング | TLS 終端（Phase 4+ で対応） |
| CNI Plugin | IP 割り当て、コンテナ管理 | マルチホスト P2P（Phase 3 で検証済み） |
| 監視スタック | Prometheus, Grafana, Alertmanager | カスタム通知設定 |
| ログ基盤 | Loki, Promtail | 長期アーカイブ |

## 2. テスト期間・スケジュール

### 2.1 期間

| 項目 | 日程 | 備考 |
|------|------|------|
| 開始日 | YYYY/MM/DD | 月曜日推奨 |
| 終了日 | YYYY/MM/DD | 7日後 |
| 予備日 | YYYY/MM/DD | 問題対処用 |

### 2.2 日次スケジュール

| 時間帯 | アクティビティ |
|--------|----------------|
| 09:00 | 日次確認チェック開始 |
| 09:30 | Git 操作テスト（clone, push, pull） |
| 10:00 | コンテナ操作テスト（停止、起動） |
| 随時 | 通常利用（ブラウザアクセス） |
| 17:00 | 日次ログ記録 |

### 2.3 特別テスト

| テスト | 実施日 | 内容 |
|--------|--------|------|
| 負荷テスト | Day 3 | 段階的負荷テスト |
| 再起動テスト | Day 5 | WSL2/Windows 再起動後の復旧確認 |
| 長時間放置テスト | Day 6-7 | 週末の無人運用 |

## 3. テストシナリオ

### 3.1 通常利用テスト

**目的:** 日常的な操作が安定して動作することを確認

| ID | シナリオ | 操作 | 期待結果 |
|----|---------|------|----------|
| N-01 | Forgejo ダッシュボード | ブラウザで Forgejo にアクセス | ページが 3 秒以内に表示 |
| N-02 | リポジトリ閲覧 | リポジトリ一覧、ファイル閲覧 | 正常に表示 |
| N-03 | 検索機能 | コード検索を実行 | 結果が表示される |
| N-04 | ユーザー操作 | ログイン/ログアウト | 正常に動作 |

### 3.2 Git 操作テスト

**目的:** Git プロトコル経由の操作が安定して動作することを確認

| ID | シナリオ | 操作 | 期待結果 |
|----|---------|------|----------|
| G-01 | リポジトリ clone | `git clone http://...` | 正常に完了 |
| G-02 | ファイル push | 変更をコミットして push | 正常に完了 |
| G-03 | ファイル pull | リモートの変更を pull | 正常に完了 |
| G-04 | 大容量ファイル | 100MB ファイルを push | タイムアウトなく完了 |
| G-05 | 競合解決 | コンフリクトを作成・解決 | 正常に動作 |

### 3.3 コンテナ操作テスト

**目的:** コンテナのライフサイクル管理が安定して動作することを確認

| ID | シナリオ | 操作 | 期待結果 |
|----|---------|------|----------|
| C-01 | コンテナ停止 | `podman stop forgejo` | 正常に停止、Gateway でエラー |
| C-02 | コンテナ起動 | `podman start forgejo` | 正常に起動、アクセス復旧 |
| C-03 | コンテナ再作成 | stop → rm → run | IP が正しく割り当てられる |
| C-04 | 複数コンテナ | 複数コンテナを同時起動 | 各コンテナに一意の IP |

### 3.4 監視確認テスト

**目的:** 監視システムが正常に動作していることを確認

| ID | シナリオ | 操作 | 期待結果 |
|----|---------|------|----------|
| M-01 | Prometheus | メトリクス確認 | データが収集されている |
| M-02 | Grafana ダッシュボード | 各ダッシュボード確認 | グラフが表示される |
| M-03 | アラート確認 | Alertmanager UI 確認 | アラートが正常に動作 |
| M-04 | ログ検索 | Loki でログを検索 | 最新ログが検索可能 |

### 3.5 再起動テスト

**目的:** システム再起動後の復旧を確認

| ID | シナリオ | 操作 | 期待結果 |
|----|---------|------|----------|
| R-01 | WSL2 再起動 | `wsl --shutdown` → 起動 | 5 分以内にサービス復旧 |
| R-02 | Windows 再起動 | Windows を再起動 | 10 分以内にサービス復旧 |
| R-03 | Gateway 再起動 | OpenResty 再起動 | 30 秒以内に復旧 |
| R-04 | 監視スタック再起動 | podman-compose restart | 2 分以内に復旧 |

### 3.6 負荷テスト

**目的:** システムの性能限界を把握

| ID | シナリオ | 同時接続 | 期間 | 測定項目 |
|----|---------|----------|------|----------|
| L-01 | ベースライン | 10 | 30秒 | RPS, レイテンシ |
| L-02 | 中負荷 | 50 | 60秒 | RPS, レイテンシ, エラー率 |
| L-03 | 高負荷 | 100 | 60秒 | RPS, レイテンシ, エラー率 |
| L-04 | 限界テスト | 200 | 60秒 | 限界値の特定 |

## 4. 成功基準

### 4.1 定量基準

| 項目 | 基準 | 測定方法 | 重要度 |
|------|------|----------|--------|
| 可用性 | 99% 以上 | (総時間 - ダウンタイム) / 総時間 | Critical |
| エラーレート | 1% 未満 | エラーリクエスト / 総リクエスト | Critical |
| 重大障害 | 0 件 | サービス停止を伴う障害の件数 | Critical |
| レスポンスタイム（p95） | 1 秒未満 | Prometheus メトリクス | High |
| レスポンスタイム（p99） | 3 秒未満 | Prometheus メトリクス | Medium |

### 4.2 定性基準

| 項目 | 基準 | 評価方法 |
|------|------|----------|
| 運用手順の妥当性 | 手順書通りに操作可能 | 実際の操作で確認 |
| アラートの有効性 | 問題発生時に適切にアラート | 意図的な障害で確認 |
| ログの可用性 | 問題調査に必要な情報がある | 障害分析で確認 |
| ドキュメントの完全性 | 不明点なく運用可能 | テスト中の疑問点を記録 |

### 4.3 本番運用開始の判断基準

| 判定 | 条件 |
|------|------|
| Go | 全ての Critical 基準を満たし、High 基準の 80% 以上を満たす |
| Conditional Go | Critical 基準を満たし、未達の High/Medium 項目に緩和策がある |
| No-Go | Critical 基準を 1 つでも満たさない |

## 5. 監視項目

### 5.1 メトリクス監視

| 項目 | 確認頻度 | アラート閾値 |
|------|----------|--------------|
| CPU 使用率 | 常時 | 80% (5分間) |
| メモリ使用率 | 常時 | 85% |
| ディスク使用率 | 常時 | 80% warning, 90% critical |
| HTTP リクエスト数 | 常時 | - |
| HTTP エラー数 | 常時 | 5% (5分間) |
| レスポンスタイム | 常時 | p95 > 1s (5分間) |

### 5.2 ログ監視

| ログ | 確認内容 | 頻度 |
|------|----------|------|
| Gateway access.log | 異常なリクエストパターン | 日次 |
| Gateway error.log | エラーメッセージ | 日次 |
| CNI Plugin | 操作ログ、エラー | 日次 |
| Container logs | アプリケーションエラー | 日次 |

### 5.3 ヘルスチェック

| サービス | エンドポイント | 確認頻度 |
|----------|----------------|----------|
| Gateway | http://localhost:80/ | 30秒毎 |
| Prometheus | http://localhost:9090/-/ready | 30秒毎 |
| Grafana | http://localhost:3000/api/health | 30秒毎 |
| Alertmanager | http://localhost:9093/-/ready | 30秒毎 |
| Loki | http://localhost:3100/ready | 30秒毎 |

## 6. 役割と責任

| 役割 | 担当者 | 責任 |
|------|--------|------|
| テスト実施者 | (記入) | 日次確認、テスト実行 |
| テスト管理者 | (記入) | 進捗管理、問題エスカレーション |
| 技術支援 | (記入) | 問題調査、対処 |

## 7. リスクと緩和策

| リスク | 影響 | 緩和策 |
|--------|------|--------|
| テスト中のサービス停止 | 開発作業への影響 | 事前告知、代替環境の準備 |
| 負荷テストによる障害 | システム破損 | 段階的な負荷増加、監視強化 |
| テスト期間の延長 | スケジュール遅延 | 予備日の確保、優先度付け |

## 8. 成果物

| 成果物 | ファイルパス | 作成タイミング |
|--------|--------------|----------------|
| 日次確認ログ | `docs/operations/daily-logs/day-X.md` | 毎日 |
| 負荷テスト結果 | `docs/operations/load-test-report.md` | Day 3 |
| 既知の問題一覧 | `docs/operations/known-issues.md` | 随時更新 |
| 運用テストレポート | `docs/operations/validation-report.md` | テスト終了時 |

## 9. 承認

| 役割 | 氏名 | 日付 | 署名 |
|------|------|------|------|
| テスト計画作成者 | | | |
| テスト計画承認者 | | | |

---

## 付録

### A. 関連ドキュメント

- [運用手順書](../phases/phase-4/stage-4-operations.md)
- [監視スタック README](../../monitoring/README.md)
- [トラブルシューティング](runbook.md)

### B. ツール

- 負荷テストスクリプト: `tests/validation/load-test.sh`
- ヘルスチェックスクリプト: `tests/validation/health-check.sh`

### C. 連絡先

| 目的 | 連絡先 |
|------|--------|
| 緊急時 | (記入) |
| 技術的な質問 | (記入) |
| 進捗報告 | (記入) |
